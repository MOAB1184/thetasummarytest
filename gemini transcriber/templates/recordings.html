<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Audio - ThetaSummary</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0;
        }
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #1a1a1a;
            transition: all 0.3s ease;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 100;
            transform: translateX(-250px);
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            text-decoration: none;
        }
        .close-menu {
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .sidebar-menu {
            padding: 20px 0;
        }
        .sidebar-menu-title {
            padding: 0 20px;
            margin-bottom: 10px;
            color: #a0a0a0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #e0e0e0;
            transition: all 0.2s ease;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #242424;
        }
        .menu-item-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #333;
        }
        .sidebar-footer-text {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #e0e0e0;
            padding: 10px 15px;
            background-color: #242424;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .logout-btn:hover {
            background-color: #333;
        }
        .logout-icon {
            margin-right: 8px;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 0;
            transition: all 0.3s ease;
            width: 100%;
        }
        .main-content.sidebar-active {
            margin-left: 250px;
            width: calc(100% - 250px);
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-title {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .user-menu {
            position: relative;
        }
        .user-button {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Recording Interface Styles */
        .recording-section {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        .audio-visualizer {
            width: 100%;
            height: 150px;
            background-color: #242424;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }
        .canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #visualizer {
            width: 100%;
            height: 100%;
        }
        .recording-timer {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }
        .recording-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-recording {
            background-color: #e74c3c;
            color: white;
        }
        .recording-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #ffffff;
            color: #121212;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .status-indicator .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-dot.idle {
            background-color: #95a5a6;
        }
        .status-dot.recording {
            background-color: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        .status-dot.processing {
            background-color: #f39c12;
            animation: pulse 1.5s infinite;
        }
        .status-dot.complete {
            background-color: #2ecc71;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Results Section Styles */
        .results-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .result-card {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .card-title {
            font-size: 1.5rem;
            margin: 0;
        }
        .download-btn {
            padding: 8px 16px;
            background-color: #242424;
            color: #e0e0e0;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .download-btn:hover {
            background-color: #333;
        }
        .card-content {
            max-height: 400px;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 0;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .error-message {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #e74c3c;
        }
        
        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Responsive Styles */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 250px;
                width: calc(100% - 250px);
            }
            .close-menu {
                display: none;
            }
        }
        
        @media (max-width: 767px) {
            .main-content.sidebar-active {
                margin-left: 0;
                width: 100%;
                opacity: 0.7;
            }
            .recording-controls {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
        
        .class-select-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }
        .class-select-label {
            color: #a0a0a0;
            font-size: 1rem;
            margin-bottom: 2px;
            font-weight: 500;
        }
        .class-select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #242424;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s, box-shadow 0.2s;
            margin-bottom: 0;
        }
        .class-select:focus, .class-select:hover {
            border: 1.5px solid #4f8cff;
            box-shadow: 0 0 0 2px #4f8cff33;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard" class="sidebar-logo">ThetaSummary</a>
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-menu-title">Menu</div>
                <a href="/dashboard" class="menu-item">
                    <div class="menu-item-icon">üìä</div>
                    Dashboard
                </a>
                <a href="/classes/create" class="menu-item">
                    <div class="menu-item-icon">üè´</div>
                    Create New Class
                </a>
            </div>
            <div class="sidebar-footer">
                <div class="sidebar-footer-text">Logged in as {{ current_user.username }}</div>
                <a href="{{ url_for('logout') }}" class="logout-btn">
                    <span class="logout-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                    </span>
                    Logout
                </a>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="page-title">Record Audio</h1>
                <div class="user-menu">
                    <button class="user-button">
                        <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                        <span>{{ current_user.username }}</span>
                    </button>
                </div>
            </header>
            
            <div class="recording-section">
                <div class="audio-visualizer">
                    <div class="canvas-container">
                        <canvas id="visualizer"></canvas>
                    </div>
                    <div class="recording-timer" id="timer">00:00</div>
                    <div class="recording-status" id="recording-status"></div>
                </div>
                
                <div class="status-indicator">
                    <div class="status-dot idle" id="status-dot"></div>
                    <span id="status-text">Ready to record</span>
                </div>
                
                <div class="recording-controls">
                    <button id="record-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 11a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v3a3 3 0 0 0 3 3z"/>
                            <path d="M13 8c0 2.21-1.79 4-4 4-2.21 0-4-1.79-4-4H3c0 2.67 2.04 4.87 4.65 5.27V16h2.7v-2.73c2.61-.4 4.65-2.6 4.65-5.27h-2z"/>
                        </svg>
                        Start Recording
                    </button>
                    <button id="stop-btn" class="btn btn-danger" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                        </svg>
                        Stop Recording
                    </button>
                </div>
                
                <div id="error-message" class="error-message hidden"></div>
            </div>
            
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
            </div>

            <div id="results-section" class="results-section hidden">
                <div class="result-card">
                    <div class="card-header">
                        <h2 class="card-title">Transcript</h2>
                        <a id="download-transcript" class="download-btn" href="#" download>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download
                        </a>
                    </div>
                    <div id="transcript-content" class="card-content"></div>
                </div>
                
                <div id="summary-section" class="hidden">
                    <div class="result-card">
                        <div class="card-header">
                            <h2 class="card-title">Summary</h2>
                            <a id="download-summary" class="download-btn" href="#" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Download
                            </a>
                        </div>
                        <div id="summary-content" class="card-content"></div>
                    </div>
                    
                    <div class="result-card">
                        <div class="card-header">
                            <h2 class="card-title">Detected Subject</h2>
                        </div>
                        <div id="subject-content" class="card-content"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Sidebar elements (only add listeners if elements exist)
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const sidebarOverlay = document.querySelector('.sidebar-overlay');

                function toggleSidebar() {
                    sidebar.classList.toggle('active');
                    mainContent.classList.toggle('sidebar-active');
                    sidebarOverlay.classList.toggle('active');
                }

                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', toggleSidebar);
                }

                // Recording elements
                const recordBtn = document.getElementById('record-btn');
                const stopBtn = document.getElementById('stop-btn');
                const timerEl = document.getElementById('timer');
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const recordingStatus = document.getElementById('recording-status');
                const resultsSection = document.getElementById('results-section');
                const loadingSection = document.getElementById('loading');
                const transcriptContent = document.getElementById('transcript-content');
                const summaryContent = document.getElementById('summary-content');
                const subjectContent = document.getElementById('subject-content');
                const downloadTranscript = document.getElementById('download-transcript');
                const downloadSummary = document.getElementById('download-summary');
                const errorMessage = document.getElementById('error-message');
                const visualizer = document.getElementById('visualizer');

                let mediaRecorder;
                let audioChunks = [];
                let recordingTimer;
                let seconds = 0;
                let isRecording = false;
                let audioContext;
                let analyser;
                let canvasContext = visualizer.getContext('2d');
                let dataArray;
                let animationId;

                // Set canvas size
                visualizer.width = visualizer.offsetWidth;
                visualizer.height = visualizer.offsetHeight;

                // Check secure context
                if (!window.isSecureContext) {
                    showError('Audio recording is only available in a secure context (HTTPS or localhost).');
                    recordBtn.disabled = true;
                    stopBtn.disabled = true;
                }

                // Update timer function
                function updateTimer() {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    timerEl.textContent = `${mins}:${secs}`;
                }

                // On page load, get class_id from query string
                let urlParams = new URLSearchParams(window.location.search);
                let classId = urlParams.get('class_id');
                if (!classId) {
                    showError('No class selected. Please access recording from a class details page.');
                    recordBtn.disabled = true;
                    stopBtn.disabled = true;
                } else {
                    recordBtn.disabled = false;
                    stopBtn.disabled = true;
                }

                // Start recording
                recordBtn.addEventListener('click', async function() {
                    console.log('Record button clicked');
                    try {
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            showError('Your browser does not support audio recording.');
                            return;
                        }

                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        if (!audioContext) {
                            throw new Error('AudioContext not supported');
                        }

                        analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        analyser.fftSize = 256;
                        const bufferLength = analyser.frequencyBinCount;
                        dataArray = new Uint8Array(bufferLength);

                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.addEventListener('dataavailable', e => {
                            audioChunks.push(e.data);
                        });

                        mediaRecorder.addEventListener('stop', function() {
                            cancelAnimationFrame(animationId);
                            statusDot.className = 'status-dot processing';
                            statusText.textContent = 'Processing audio...';
                            recordingStatus.textContent = '';
                            recordingStatus.className = 'recording-status';
                            isRecording = false;
                            clearInterval(recordingTimer);
                            loadingSection.classList.remove('hidden');
                            processRecording();
                        });

                        mediaRecorder.start();
                        isRecording = true;
                        recordBtn.disabled = true;
                        stopBtn.disabled = false;
                        statusDot.className = 'status-dot recording';
                        statusText.textContent = 'Recording...';
                        recordingStatus.textContent = 'REC';
                        recordingStatus.className = 'recording-status status-recording';
                        seconds = 0;
                        updateTimer();
                        recordingTimer = setInterval(updateTimer, 1000);
                        drawVisualizer();
                    } catch (err) {
                        console.error('Error accessing microphone or AudioContext:', err);
                        showError('Could not initialize audio recording. Ensure microphone access and browser compatibility.');
                    }
                });

                // Visualizer function
                function drawVisualizer() {
                    analyser.getByteFrequencyData(dataArray);
                    canvasContext.fillStyle = '#242424';
                    canvasContext.fillRect(0, 0, visualizer.width, visualizer.height);
                    const barWidth = (visualizer.width / dataArray.length) * 2.5;
                    let barHeight;
                    let x = 0;

                    for (let i = 0; i < dataArray.length; i++) {
                        barHeight = dataArray[i] / 2;
                        const gradient = canvasContext.createLinearGradient(0, 0, 0, visualizer.height);
                        gradient.addColorStop(0, '#ffffff');
                        gradient.addColorStop(1, '#555555');
                        canvasContext.fillStyle = gradient;
                        canvasContext.fillRect(x, visualizer.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }

                    animationId = requestAnimationFrame(drawVisualizer);
                }

                // Stop recording
                stopBtn.addEventListener('click', function() {
                    if (mediaRecorder && isRecording) {
                        mediaRecorder.stop();
                        recordBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                });

                // Process recording
                async function processRecording() {
                    try {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();

                        reader.onload = async function() {
                            const base64AudioDataUrl = reader.result;
                            const base64Audio = base64AudioDataUrl.split(',')[1];
                            resultsSection.classList.add('hidden');
                            document.getElementById('summary-section').classList.add('hidden');
                            statusText.textContent = 'Uploading and transcribing audio...';

                            try {
                                const transcribeResponse = await fetch('/api/transcribe', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        audio_base64: base64Audio,
                                        mime_type: audioBlob.type
                                    }),
                                });

                                const transcribeData = await transcribeResponse.json();

                                if (transcribeData.status === 'success') {
                                    transcriptContent.textContent = transcribeData.transcript;
                                    downloadTranscript.href = `/download/${transcribeData.transcript_filename}`;
                                    downloadTranscript.download = transcribeData.transcript_filename;
                                    loadingSection.classList.remove('hidden');
                                    resultsSection.classList.remove('hidden');
                                    statusDot.className = 'status-dot complete';
                                    statusText.textContent = 'Transcript complete. Generating summary...';

                                    try {
                                        const summarizeResponse = await fetch('/api/summarize', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                transcript: transcribeData.transcript,
                                                timestamp: transcribeData.timestamp,
                                                class_id: classId
                                            }),
                                        });
                                        const summarizeData = await summarizeResponse.json();
                                        if (summarizeData.status === 'success') {
                                            document.getElementById('summary-content').innerHTML = formatSummary(summarizeData.summary);
                                            downloadSummary.href = `/download/${summarizeData.summary_filename}`;
                                            downloadSummary.download = summarizeData.summary_filename;
                                            document.getElementById('subject-content').textContent = summarizeData.subject || "General";
                                            document.getElementById('summary-section').classList.remove('hidden');
                                            loadingSection.classList.add('hidden');
                                            statusDot.className = 'status-dot complete';
                                            statusText.textContent = 'Summary generation complete';
                                        } else {
                                            loadingSection.classList.add('hidden');
                                            showError(summarizeData.message || 'Unknown error occurred during summarization');
                                            statusDot.className = 'status-dot idle';
                                            statusText.textContent = 'Error generating summary';
                                        }
                                    } catch (err) {
                                        loadingSection.classList.add('hidden');
                                        showError("Server error: " + (err.message || "Failed to generate summary"));
                                        statusDot.className = 'status-dot idle';
                                        statusText.textContent = 'Error generating summary';
                                    }
                                } else {
                                    loadingSection.classList.add('hidden');
                                    showError(transcribeData.message || 'Unknown error occurred during transcription');
                                    statusDot.className = 'status-dot idle';
                                    statusText.textContent = 'Error transcribing audio';
                                }
                            } catch (err) {
                                loadingSection.classList.add('hidden');
                                showError("Server error: " + (err.message || "Failed to process audio"));
                                statusDot.className = 'status-dot idle';
                                statusText.textContent = 'Error processing audio';
                                console.error("Error communicating with server:", err);
                            }
                        };

                        reader.readAsDataURL(audioBlob);
                    } catch (err) {
                        console.error("Error processing recording:", err);
                        loadingSection.classList.add('hidden');
                        showError("Failed to process recording. Please try again.");
                        statusDot.className = 'status-dot idle';
                        statusText.textContent = 'Error processing audio';
                    }
                }

                // Format summary for LaTeX content
                function formatSummary(summary) {
                    return summary.replace(/\\section\{([^}]+)\}/g, '<h2>$1</h2>')
                                .replace(/\\subsection\{([^}]+)\}/g, '<h3>$1</h3>')
                                .replace(/\\begin\{document\}/g, '')
                                .replace(/\\end\{document\}/g, '')
                                .replace(/\\begin\{itemize\}/g, '<div class="itemize">')
                                .replace(/\\end\{itemize\}/g, '</div>')
                                .replace(/\\item/g, '<div class="item">')
                                .replace(/\\textbf\{([^}]+)\}/g, '<strong>$1</strong>')
                                .replace(/\\emph\{([^}]+)\}/g, '<em>$1</em>')
                                .replace(/\n\n/g, '<br><br>');
                }

                // Show error message
                function showError(message) {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                    setTimeout(() => {
                        errorMessage.classList.add('hidden');
                    }, 10000);
                }

                // Adjust canvas size on window resize
                window.addEventListener('resize', function() {
                    visualizer.width = visualizer.offsetWidth;
                    visualizer.height = visualizer.offsetHeight;
                });

                // Handle responsive behavior
                function handleResize() {
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                        mainContent.classList.remove('sidebar-active');
                        sidebarOverlay.classList.remove('active');
                    }
                }

                window.addEventListener('resize', handleResize);
                handleResize();
            } catch (err) {
                console.error('Error in DOMContentLoaded:', err);
                showError('An error occurred while initializing the page. Check the console for details.');
            }
        });
    </script>
</body>
</html> 